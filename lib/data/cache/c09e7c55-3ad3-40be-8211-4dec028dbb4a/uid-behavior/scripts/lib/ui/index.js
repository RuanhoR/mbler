import{baseUi}from"./baseUi";import{utils}from"./../utils/index";import{Lore}from"./Lore";class ItemBagUI extends baseUi{initLayout(){this.layouts=this.game.regLayout({regIds:["Home","NumSelect","showInNoFound"],Home:{title:"菜单",layout:[{type:"button",param:["存入物品"]},{type:"button",param:["取出物品"]}]},NumSelect:{title:"选择数量",layout:[]},showInNoFound:{title:"请选择要存入的物品",layout:[{type:"label",param:["点击你想要存放的物品"]}]}})}openHomeForm(e,t){this.layouts||this.initLayout();const o=new Lore(t),a=this.game.createForm("Action",this.layouts[0]);a.addLayout({type:"label",param:[`无尽袋子 - 菜单\n物品 : ${o.name} , 数量 : ${o.count}`]}),a.show(e,!0).onCommit(({selection:o})=>{switch(o){case 0:this.openAddItemForm(e,t);break;case 1:this.hanlerTakeOutItems(e,t);break;default:e.sendMessage("请选择存入或取出")}})}hanlerTakeOutItems(e,t){const o=new Lore(t);if(!o.name)return e.sendMessage("没有存入任何东西");this.selectionNum({min:1,max:o.count,tit:o.name,callback:({formValues:a})=>{const s=a[0];e.runCommand(`give @s ${o.name} ${s}`),o.count=o.count-s,t.setLore(o.parseArr()),utils.setMainHand(e,t)},lastUi:()=>this.openHomeForm(e,t)},e)}openAddItemForm(e,t){const o=new Lore(t);if(void 0===o.name)return this.showInNoData(e,o,t);const a=utils.getAllPlayerInt(e);let s=0;for(const[e,t]of a){const[e,a]=t;e===o.name&&(s+=a)}if(s<=0)return e.sendMessage("你没有该物品，无法存入！");this.selectionNum({min:0,max:s,tit:o.name,callback:({formValues:a})=>{const n=a[0];o.count=n+s,this.handlerAdd(o,e,t,n)},lastUi:()=>this.openHomeForm(e,t)},e)}showInNoData(e,t,o){const a=this.game.createForm("Action",this.layouts[2]),s=utils.getAllPlayerInt(e),n=[];let i=0;for(const[e,t]of s){if(!Array.isArray(t))continue;const[o,s]=t;a.addLayout({type:"button",param:[`${o} x${s}`]}),n[i]=e,i++}a.show(e).then(({selection:t,canceled:a})=>{if(a)return this.openHomeForm(e,o);if(void 0===t||t>=n.length)return e.sendMessage("你选择的物品无效");const i=n[t],r=s.get(i);if(!r||!Array.isArray(r))return e.sendMessage("该物品数据异常");const[m,l]=r;this.selectionNum({tit:`存入 ${m}`,min:0,max:l,callback:({formValues:t})=>{const a=t[0],s=new Lore(o);s.name=m,s.count=a+l,this.handlerAdd(s,e,o,a)},lastUi:()=>this.openHomeForm(e,o)},e)})}handlerAdd(e,t,o,a){utils.removeItems(t,{name:e.name,count:a}),o.setLore(e.parseArr()),utils.setMainHand(t,o),t.sendMessage(`成功存入 ${a} 个「${e.name}」`)}selectionNum({min:e=0,max:t=1,tit:o="",callback:a=()=>{},lastUi:s=()=>{}}={},n){const i=this.game.createForm("Modal",this.layouts[1]);i.addLayout({type:"slider",param:[o,e,t]});const r=i.show(n,!0);r.onCancel(s),r.onCommit(a)}}export default ItemBagUI;